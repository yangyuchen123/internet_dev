services:
  mysql:
    image: mysql:8.0
    container_name: ${PROJECT_NAME:-ai-agent-platform}-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-chenhao20030210}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ai_agent_db}
      MYSQL_USER: ${MYSQL_USER:-test_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-12345678}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_0900_ai_ci",
      "--skip-name-resolve",
      "--explicit_defaults_for_timestamp"
    ]
    volumes:
      - backend_mysql_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: ${PROJECT_NAME:-ai-agent-platform}-phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-test_user}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-12345678}
    ports:
      - "${PMA_PORT:-8081}:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  backend:
    container_name: ${PROJECT_NAME:-ai-agent-platform}-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: ${PROJECT_NAME:-ai-agent-platform}-backend:latest
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      # 激活生产环境配置
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}

      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/ai_agent_db?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&characterEncoding=UTF-8}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-test_user}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-12345678}
      SPRING_REDIS_HOST: ${SPRING_REDIS_HOST:-redis}
      SPRING_REDIS_PORT: ${SPRING_REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${SPRING_REDIS_PASSWORD:-12345678}
      # Java 运行参数
      JAVA_OPTS: ${JAVA_OPTS:--Xms512m -Xmx1g}



      # 时区
      TZ: ${TZ:-Asia/Shanghai}
    # volumes:
    #   - redis_data:/app/logs
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/doc.html || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  rag-service:
    build:
      context: ./online-rag-service/src
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-ai-agent-platform}-rag-service
    ports:
      - "8000:8000"
    volumes:
      - ./online-rag-service/src:/app/model:ro
    environment:
        RAG_MODEL_NAME: ${RAG_MODEL_NAME:-text-embedding-v1}
        RAG_ON_DOCKER: Y
        RAG_DB_HOST: ${MYSQL_DATABASE_HOST:-mysql}
        RAG_DB_PORT: ${MYSQL_DATABASE_PORT:-3306}
        RAG_DB_USER: ${MYSQL_USER:-test_user}
        RAG_DB_PASS: ${MYSQL_PASSWORD:-12345678}
        RAG_DB_NAME: ${MYSQL_DATABASE:-ai_agent_db}
        RAG_DATA_DIR: /app/data/kb
        QDRANT_HOST: ${QDRANT_HOST:-qdrant}
        QDRANT_PORT: ${QDRANT_PORT:-6333}
        QDRANT_GRPC_PORT: ${QDRANT_GRPC_PORT:-6334}
        DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY:-}
    depends_on:
      - mysql
      - qdrant
    networks:
      - app-network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ${PROJECT_NAME:-ai-agent-platform}-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"  # 服务API端口
      - "${QDRANT_GRPC_PORT:-6334}:6334"  # gRPC端口
    volumes:
      - ./online-rag-service/qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=${QDRANT_GRPC_PORT:-6334}
      - QDRANT__LOG_LEVEL=INFO
    networks:
      - app-network
    restart: unless-stopped



  # redis:
  #   image: redis:7-alpine
  #   container_name: ${PROJECT_NAME:-ai-agent-platform}-redis
  #   command: ["redis-server", "--appendonly", "yes"]
  #   environment:
  # Redis 配置（Docker 部署时指向 redis 服务）
      # REDIS_HOST: ${REDIS_HOST:-redis}
      # REDIS_PORT: ${REDIS_PORT:-6379}
      # REDIS_PASSWORD: ${REDIS_PASSWORD:-12345678}

  #   ports:
  #     - "${SPRING_REDIS_PORT:-6379}:6379"
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "sh", "-c", "if [ -z \"${SPRING_REDIS_PASSWORD:-}\" ]; then redis-cli ping; else redis-cli -a \"${SPRING_REDIS_PASSWORD:-}\" ping; fi"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s


  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://backend:8080}
    image: ${PROJECT_NAME:-ai-agent-platform}-frontend:latest
    container_name: ${PROJECT_NAME:-ai-agent-platform}-frontend
    ports:
      - "${WEB_ADMIN_PORT:-80}:80"
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    depends_on:
      backend:
        condition: service_healthy
      plugin-server:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

  plugin-server:
    build:
      context: ./plug-in-server
      dockerfile: Dockerfile
    image: ${PROJECT_NAME:-ai-agent-platform}-plugin-server:latest
    container_name: ${PROJECT_NAME:-ai-agent-platform}-plugin-server
    environment:
      HOST: ${PLUGIN_SERVER_HOST:-0.0.0.0}
      PORT: ${PLUGIN_SERVER_PORT:-3000}
      MYSQL_HOST: mysql
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-test_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-12345678}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ai_agent_db}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}  # 从主机环境传递 Deepseek API Key
      OPENAI_API_KEY: ${OPENAI_API_KEY}      # 从主机环境传递 OpenAI API Key



    ports:
      - "${PLUGIN_SERVER_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    depends_on:
      mysql:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # workstream:
  #   build:
  #     context: ./work_stream
  #     dockerfile: Dockerfile
  #   image: ${PROJECT_NAME:-ai-agent-platform}-workstream:latest
  #   container_name: ${PROJECT_NAME:-ai-agent-platform}-workstream
  #   environment:
  #     OPENAI_API_KEY: ${OPENAI_API_KEY}      # 从主机环境传递 OpenAI API Key
  #     TZ: ${TZ:-Asia/Shanghai}
  #     DB_HOST: mysql
  #     DB_PORT: ${MYSQL_PORT:-3306}
  #     DB_USER: ${MYSQL_USER:-test_user}
  #     DB_PASSWORD: ${MYSQL_PASSWORD:-12345678}
  #     DB_NAME: ${MYSQL_DATABASE:-ai_agent_db}
  #     DOCKER_ENV: true
  #   ports:
  #     - "8001:8001"
  #   volumes:
  #     - ./work_stream/.env:/app/.env
  #   depends_on:
  #     - mysql
  #     - backend
  #     - plugin-server
  #   networks:
  #     - app-network
  #   restart: unless-stopped

volumes:
  backend_mysql_data:

networks:
  app-network:
    driver: bridge
